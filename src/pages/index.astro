---
import '../styles/global.css'
const room = Astro.url.searchParams.get('room') ?? 'R0'
---

<html lang="zh-Hant-TW" data-theme="light">
	<head>
		<meta charset="utf-8" />
		<title>Rundown 看板</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
	</head>

	<body class="h-screen flex flex-col items-center p-4 gap-4 bg-base-100">
		<!-- 標題：房間 + 現在時間 -->
		<div class="w-full flex justify-center">
			<select id="room" class="select select-ghost select-xl text-center" value={room}>
				<option value="R0">R0</option>
				<option value="R1">R1</option>
				<option value="R2">R2</option>
				<option value="R3">R3</option>
				<option value="S">S</option>
			</select>
		</div>

		<div class="w-full flex justify-center">
			<span class="countdown font-mono text-2xl">
				<span id="hour" style="--value:00; --digits:2;" aria-live="polite" aria-label="00">00</span>
				:
				<span id="minute" style="--value:00; --digits: 2;" aria-live="polite" aria-label="00">00</span>
				:
				<span id="second" style="--value:00; --digits: 2;" aria-live="polite" aria-label="00">00</span>
			</span>
		</div>

		<!-- rundown 表格 -->
		<div class="mt-4 overflow-x-auto relative w-full rounded-box grow">
			<table class="table table-lg table-zebra table-pin-rows w-full font-mono bg-base-300">
				<thead class="h-16">
					<tr class="border-b-4 border-base-content bg-base-200 font-extrabold text-xl">
						<th class="w-1/2 text-left">名稱</th>
						<th class="w-1/4 text-center">開始</th>
						<th class="w-1/4 text-center">結束</th>
					</tr>
				</thead>
				<tbody id="rundown-body"> </tbody>
			</table>
			<div
				id="now-line"
				class="pointer-events-none absolute top-0 left-0 right-0 h-1 bg-primary shadow-md shadow-primary/60"
			>
			</div>
		</div>

		<div id="updated-at" class="btn btn-xs md:btn-sm text-base-content/60 w-full"></div>
	</body>
</html>
<script>
	const APIURL =
		'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgZpasjcZZboL6C4RvbsO4qFBz8ePDGxZKIAUclcIALRjIkd4BXJsbUXxa_nl9kGrtzVf-Nb3lrqSWb5mppP8ZWdR0ChsBsxCl708MzJoBQJFTaED5LhOuUgU3o3zCFPFKS1QxMOqDcQ-Vn61uybQUBqs4zHPzJxWYKXfP9NdAZ7KhuhEy6Oei-oKI5M2rO0lyJlrlSHjLsp-RX9dW_cCM8dbWSjc77cMOFAlIj1ODecTHSl3MBnFGIpSmEtujoB-p_QSjUEpVcGwoTp0GEFXrwu0fEiA&lib=MbNYTTEWip_g6XTlY_LN1kGb-c7rEWU4q'
	const PX_PER_MINUTE = 2 // 兩小時(120 分) = 240px，高度會是一小時(60 分)的兩倍
	const HEIGHT_THRESHOLD = 60 // 只有超過 60px 才用時間控制高度
	const THEAD_HEIGHT = 64 - 4 / 2 // 扣掉線的高度

	let room = new URLSearchParams(location.search).get('room') || 'R0'

	const $ = document.querySelector.bind(document)

	const $room = $<HTMLSelectElement>('#room')!
	const $hour = $<HTMLSpanElement>('#hour')!
	const $minute = $<HTMLSpanElement>('#minute')!
	const $second = $<HTMLSpanElement>('#second')!
	const $tbody = $<HTMLTableSectionElement>('#rundown-body')!
	const $updatedAt = $<HTMLDivElement>('#updated-at')!
	const $line = $<HTMLDivElement>('#now-line')!

	type Event = {
		name: string
		room: string
		start: number
		end: number
		duration: number
	}

	let events: Event[] = []

	function getNow() {
		return new Date()
	}

	function getNowMinute() {
		const now = getNow()
		return now.getHours() * 60 + now.getMinutes()
	}

	function formatTimeWithHour(t: Date) {
		const formatter = new Intl.DateTimeFormat('zh-TW', {
			hour: '2-digit',
			minute: '2-digit',
			second: '2-digit',
			hour12: false,
		})
		return formatter.format(t)
	}

	function formatTime(t: number) {
		const hours = String(Math.floor(t / 60)).padStart(2, '0')
		const minutes = String(t % 60).padStart(2, '0')
		return `${hours}:${minutes}`
	}

	function updateClock() {
		const now = getNow()
		const hours = String(now.getHours()).padStart(2, '0')
		const minutes = String(now.getMinutes()).padStart(2, '0')
		const seconds = String(now.getSeconds()).padStart(2, '0')

		$hour.style.setProperty('--value', hours)
		$minute.style.setProperty('--value', minutes)
		$second.style.setProperty('--value', seconds)

		$hour.innerText = hours
		$minute.innerText = minutes
		$second.innerText = seconds
	}
	updateClock()
	setInterval(updateClock, 1000)

	function renderRundown() {
		let cumHeight = 0

		$tbody.innerHTML = ''

		const nowMinutes = getNowMinute()
		let lineDrawen = false

		console.log(events)
		events
			.filter(e => e.room == room)
			.forEach(ev => {
				const tr = $tbody.insertRow()

				const height = Math.max(ev.duration * PX_PER_MINUTE, HEIGHT_THRESHOLD)

				tr.style.height = `${height}px`

				if (!lineDrawen && ev.end >= nowMinutes) {
					// 畫橫線
					const offset =
						(Math.max(nowMinutes - ev.start, 0) / ev.duration) * height + cumHeight + THEAD_HEIGHT
					$line.style.top = `${offset}px`
					tr.className = 'bg-primary/10'
					lineDrawen = true
				}

				const tdName = tr.insertCell()
				tdName.textContent = ev.name
				tdName.className = 'text-left align-top'

				const tdStart = tr.insertCell()
				tdStart.textContent = formatTime(ev.start)
				tdStart.className = 'text-center align-top'

				const tdEnd = tr.insertCell()
				tdEnd.textContent = formatTime(ev.end)
				tdEnd.className = 'text-center align-top'

				cumHeight += height
			})

		$line.scrollIntoView({
			block: 'center',
			behavior: 'smooth',
		})
	}

	// 假設欄位：A=名稱, B=開始, C=結束, D=地點
	function parseTime(t: Date) {
		const time = new Date(t)
		return time.getHours() * 60 + time.getMinutes()
	}

	async function fetchRundown() {
		try {
			const res = await fetch(`${APIURL}&t=${Date.now()}`) // t= to prevent google server cache
			if (!res.ok) throw new Error('HTTP ' + res.status)

			const data = (await res.json()) as any[]
			events = data
				.map(item => {
					const start = new Date(item['開始'])
					const end = new Date(item['結束'])

					return {
						name: item['名稱'],
						room: item['地點'],
						start: parseTime(start),
						end: parseTime(end),
						duration: parseTime(end) - parseTime(start),
					} as Event
				})
				.sort((a, b) => a.start - b.start)

			console.log(events)
			renderRundown()
			$updatedAt.textContent = `最後更新：${formatTimeWithHour(getNow())}（按一下提前更新）`
		} catch (err) {
			console.error('fetch rundown error', err)
			$updatedAt.textContent = '讀取失敗（按一下提前更新）'
		}
	}

	function setRoom() {
		room = $room.value
		history.replaceState(null, '', `?room=${room}`)
		renderRundown()
	}

	$room.addEventListener('change', setRoom)
	fetchRundown()
	setRoom()
	setInterval(fetchRundown, 30 * 1000)
	$updatedAt.addEventListener('click', fetchRundown)
</script>
