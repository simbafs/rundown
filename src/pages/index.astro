---
import '../styles/global.css'
const room = Astro.url.searchParams.get('room') ?? 'R0'
---

<html lang="zh-Hant-TW" data-theme="light">
	<head>
		<meta charset="utf-8" />
		<title>Rundown 看板</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
	</head>

	<body class="min-h-screen bg-base-200 flex flex-col items-center justify-center p-4">
		<div class="card bg-base-100 shadow-2xl max-w-5xl w-full mx-4 grow">
			<div class="card-body gap-4 grow h-1">
				<!-- 標題：房間 + 現在時間 -->
				<div class="flex flex-col items-center gap-1">
					<select
						id="room"
						class="select select-ghost text-3xl font-mono md:text-4xl text-center"
						value={room}
					>
						<option value="R0">R0</option>
						<option value="R1">R1</option>
						<option value="R2">R2</option>
						<option value="R3">R3</option>
						<option value="S">S</option>
					</select>
					<span class="countdown font-mono text-2xl">
						<span id="hour" style="--value:10;" aria-live="polite" aria-label="10">10</span>
						:
						<span id="minute" style="--value:24; --digits: 2;" aria-live="polite" aria-label="24">24</span>
						:
						<span id="second" style="--value:59; --digits: 2;" aria-live="polite" aria-label="59">59</span>
					</span>
				</div>

				<!-- rundown 表格 -->
				<div class="mt-4 overflow-x-auto relative">
					<table class="table table-lg table-zebra table-pin-rows w-full font-mono">
						<thead class="h-15">
							<tr class="border-b-4 border-base-content">
								<th class="w-1/2 text-left">名稱</th>
								<th class="w-1/4 text-center">開始</th>
								<th class="w-1/4 text-center">結束</th>
							</tr>
						</thead>
						<tbody id="rundown-body"> </tbody>
					</table>
					<div
						id="now-line"
						class="pointer-events-none absolute top-0 left-0 right-0 h-1 bg-primary shadow-md shadow-primary/60"
					>
					</div>
				</div>

				<div id="updated-at" class="btn btn-xs md:btn-sm text-base-content/60"></div>
			</div>
		</div>
	</body>
</html>
<script>
	const SHEETURL =
		'https://docs.google.com/spreadsheets/d/e/2PACX-1vQMJlpt3adXG_zgK36gtQbNjQvmEmt5-a60PKiYMgvrgy9Ni4GmPD1sPj0036DnEWXflOqPt9n_W57o/pub?gid=0&single=true&output=csv'
	const PX_PER_MINUTE = 2 // 兩小時(120 分) = 240px，高度會是一小時(60 分)的兩倍
	const HEIGHT_THRESHOLD = 60 // 只有超過 60px 才用時間控制高度
	const THEAD_HEIGHT = 60 - 4 / 2 // 扣掉線的高度

	let room = new URLSearchParams(location.search).get('room') || 'R0'

	const $ = document.querySelector.bind(document)

	const $room = $<HTMLSelectElement>('#room')!
	const $hour = $<HTMLSpanElement>('#hour')!
	const $minute = $<HTMLSpanElement>('#minute')!
	const $second = $<HTMLSpanElement>('#second')!
	const $tbody = $<HTMLTableSectionElement>('#rundown-body')!
	const $updatedAt = $<HTMLDivElement>('#updated-at')!
	const $line = $<HTMLDivElement>('#now-line')!

	type Event = {
		name: string
		room: string
		start: string // HH:MM
		end: string // HH:MM
	}

	function getNow() {
		return new Date()
	}

	function getNowMinute() {
		const now = getNow()
		return now.getHours() * 60 + now.getMinutes()
	}

	function formatTime(t: Date) {
		const formatter = new Intl.DateTimeFormat('zh-TW', {
			hour: '2-digit',
			minute: '2-digit',
			second: '2-digit',
			hour12: false,
		})
		return formatter.format(t)
	}

	function updateClock() {
		const now = getNow()
		const hours = String(now.getHours()).padStart(2, '0')
		const minutes = String(now.getMinutes()).padStart(2, '0')
		const seconds = String(now.getSeconds()).padStart(2, '0')

		$hour.style.setProperty('--value', hours)
		$minute.style.setProperty('--value', minutes)
		$second.style.setProperty('--value', seconds)

		$hour.innerText = hours
		$minute.innerText = minutes
		$second.innerText = seconds
	}
	updateClock()
	setInterval(updateClock, 1000)

	function parseTimeToMinutes(str: string) {
		if (!str) return 0
		const m = String(str)
			.trim()
			.match(/^(\d{1,2}):(\d{2})$/)
		if (!m) return 0
		const h = parseInt(m[1], 10)
		const min = parseInt(m[2], 10)
		return h * 60 + min
	}

	function renderRundown(events: Event[]) {
		let cumHeight = 0

		$tbody.innerHTML = ''

		const parsed = events
			.map(ev => {
				const startMinutes = parseTimeToMinutes(ev.start)
				const endMinutes = parseTimeToMinutes(ev.end)
				return {
					...ev,
					startMinutes,
					endMinutes,
					durationMinutes: Math.max(endMinutes - startMinutes, 1),
				}
			})
			.sort((a, b) => a.startMinutes - b.startMinutes)

		const nowMinutes = getNowMinute()
		let lineDrawen = false

		parsed.forEach(ev => {
			const tr = $tbody.insertRow()

			const height = Math.max(ev.durationMinutes * PX_PER_MINUTE, HEIGHT_THRESHOLD)

			tr.style.height = `${height}px`

			if (!lineDrawen && ev.endMinutes >= nowMinutes) {
				// 畫橫線
				const offset =
					(Math.max(nowMinutes - ev.startMinutes, 0) / ev.durationMinutes) * height + cumHeight + THEAD_HEIGHT
				$line.style.top = `${offset}px`
				tr.className = 'bg-primary/10'
				lineDrawen = true
			}

			const tdName = tr.insertCell()
			tdName.textContent = ev.name
			tdName.className = 'text-left align-top'

			const tdStart = tr.insertCell()
			tdStart.textContent = ev.start
			tdStart.className = 'text-center align-top'

			const tdEnd = tr.insertCell()
			tdEnd.textContent = ev.end
			tdEnd.className = 'text-center align-top'

			cumHeight += height
		})

		$line.scrollIntoView({
			block: 'center',
			behavior: 'smooth',
		})
	}

	// 假設欄位：A=名稱, B=開始, C=結束, D=地點
	function parseCsv(csvText: string, room: string): Event[] {
		const lines = csvText
			.split(/\r?\n/)
			.map(l => l.trim())
			.filter(l => l.length > 0)

		if (lines.length <= 1) return []

		const events: Event[] = []

		for (let i = 1; i < lines.length; i++) {
			const cols = lines[i].split(',')
			const [name, start, end, place] = [cols[0] ?? '', cols[1] ?? '', cols[2] ?? '', cols[3] ?? ''].map(c =>
				c.trim(),
			)

			if (!name) continue
			if (room && place && place !== room) continue

			events.push({ name, start, end, room: place })
		}

		return events
	}

	async function fetchRundown() {
		try {
			const res = await fetch(`${SHEETURL}&t=${Date.now()}`) // t= to prevent google server cache
			if (!res.ok) throw new Error('HTTP ' + res.status)
			const csv = await res.text()
			const events = parseCsv(csv, room)
			console.log(events)
			renderRundown(events)
			$updatedAt.textContent = `最後更新：${formatTime(getNow())}（按一下提前更新）`
		} catch (err) {
			console.error('fetch rundown error', err)
			$updatedAt.textContent = '讀取失敗（按一下提前更新）'
		}
	}

	function setRoom() {
		room = $room.value
		history.replaceState(null, '', `?room=${room}`)
		fetchRundown()
	}

	$room.addEventListener('change', setRoom)
	setRoom()
	setInterval(fetchRundown, 30 * 1000)
	$updatedAt.addEventListener('click', fetchRundown)
</script>
